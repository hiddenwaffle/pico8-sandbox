pico-8 cartridge // http://www.pico-8.com
version 18
__lua__

-- coding challenge #50.1
-- https://www.youtube.com/watch?v=QHEQuoIKgNE

#include lib/vector2d.p8:0

g = { }

function _init()
  cls(1)
  g.circles = { }
  g.spots = { }
  g.no_loop = false
  -- for i = 1, 1 do
  --   add(g.circles, circle_type:new(64, 64))
  -- end
  sspr(8, 0, 64, 64, 2, 2, 128, 128)
  for x = 0, 127 do
    for y = 0, 127 do
      local c = pget(x, y)
      if c != 1 then -- i.e., not background color from cls(1) above
        add(g.spots, vector2d_type:new(x, y))
      end
    end
  end
end

function _update60()
  if (g.no_loop) return
  local total = 2 -- add multiple circles at a time
  local count = 0
  local attempts = 0
  while count < total do
    local new_c = new_circle()
    if new_c then
      add(g.circles, new_c)
      count += 1
    end
    attempts += 1
    if attempts > 100 then
      g.no_loop = true
    end
  end
  for c in all(g.circles) do
    if c:edges() then
      c.growing = false
    else
      for other in all(g.circles) do
        if c != other then
          local d = dist_16bit(c.x, c.y, other.x, other.y)
          if d < c.r + other.r then
            c.growing = false
            break
          end
        end
      end
    end
    c:grow()
  end
end

function _draw()
  cls(1)
  -- sspr(8, 0, 64, 64, 2, 2, 128, 128)
  for circle in all(g.circles) do
    circle:show()
  end
end

-->8

circle_type =  { }

function circle_type:new(x, y)
  local o = {
    x = x,
    y = y,
    r = 1,
    growing = true
  }
  setmetatable(o, self)
  self.__index = self
  return o
end

function circle_type:grow()
  if self.growing then
    self.r += 1
  end
end

function circle_type:edges()
  return self.x + self.r >= 127 or
         self.x - self.r <    0 or
         self.y + self.r >= 127 or
         self.y - self.r <    0
end

function circle_type:show()
  circfill(self.x, self.y, self.r, 3)
  circ(self.x, self.y, self.r, 11)
end

-->8

function new_circle()
  local r = flr(rnd(#g.spots)) + 1
  local spot = g.spots[r]
  local x = spot.x
  local y = spot.y
  local valid = true
  for c in all(g.circles) do
    local d = dist_16bit(x, y, c.x, c.y)
    if d < c.r then
      valid = false
      break
    end
  end
  if valid then
    return circle_type:new(x, y)
  else
    return nil
  end
end

-- taken from vector2d lib
function dist_16bit(x1, y1, x2, y2)
  local x1 *= 0.001
  local x2 *= 0.001
  local y1 *= 0.001
  local y2 *= 0.001
  local a = sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1))
  return a / 0.001
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000777700000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000077777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000007777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000077777777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000
00000000000000007777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000000
00000000000000077777777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000
00000000000007777777777777777777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000
00000000000077777777777777777777777777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000
00000000000777777777777777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000
00000000077777777777777777777777777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000
00000000777777777777777777777777777777777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000
00000000777777777777777777777777777777777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000
00000000777777777777777777777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777777777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777777777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777777777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777777777770000000000777777777777777777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777777777000000000000000077777777777777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777777770000000000000000000007777777777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777777700000000000000000000000000777777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777770000000000000000000000000000007777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777700000000000000000000000000000000777777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777000000000000000000000000000000000077777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777770000000000000000000000000000000000077777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777770000000000000000000000000000000000007777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777770000000000000000000000000000000000007777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777770000000000000000000000000000000000007777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777700000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777700000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777700000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777700000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777770000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777770000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777770000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777770000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777000000000000000000000000000000000007777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777000000000000000000000000000000000007777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777000000000000000000000000000000000077777777777777700000000000000000000000000000000000000000000000000000000
00000000777777777777777700000000000000000000000000000000077777777777777700000000000000000000000000000000000000000000000000000000
00000000077777777777777700000000000000000000000000000000077777777777777000000000000000000000000000000000000000000000000000000000
00000000077777777777777770000000000000000000000000000000777777777777770000000000000000000000000000000000000000000000000000000000
00000000007777777777777770000000000000000000000000000000777777777777770000000000000000000000000000000000000000000000000000000000
00000000000777777777777777700000000000000000000000000077777777777777770000000000000000000000000000000000000000000000000000000000
00000000000777777777777777770000000000000000000000000077777777777777770000000000000000000000000000000000000000000000000000000000
00000000000077777777777777777770000000000000000000007777777777777777700000000000000000000000000000000000000000000000000000000000
00000000000077777777777777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000
00000000000007777777777777777777777777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000
00000000000000777777777777777777777777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000
00000000000000777777777777777777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000
00000000000000077777777777777777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000
00000000000000077777777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000
00000000000000007777777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000
00000000000000000777777777777777777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000
00000000000000000000777777777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000077777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000077777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000777777777777700000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000007777700000000000000000000000000000000000000000000000000000000000000000000000000
