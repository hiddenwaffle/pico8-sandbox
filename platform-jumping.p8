pico-8 cartridge // http://www.pico-8.com
version 18
__lua__

-- based on:
-- http://gamedev.docrobs.co.uk/first-steps-in-pico-8-easy-collisions-with-map-tiles
-- the bunny occasionally get stuck in the corner of blocks.
-- the jump and walk acceleration can stand some better feel calculations.

function _init()
  g_bunny = {
    x = 16,
    y = 96,
    dx = 0,
    dy = 0,
    facing_left = false,
    on_ground = false,
    jump = 0
  }
end

function _update60()
  g_bunny.dy += 0.05
  if btn(0) then
    g_bunny.dx -= 0.03
    g_bunny.facing_left = true
  end
  if btn(1) then
    g_bunny.dx += 0.03
    g_bunny.facing_left = false
  end

  if btnp(2) and (g_bunny.on_ground or g_bunny.jump < 2) then
    g_bunny.on_ground = false
    g_bunny.jump += 1
    g_bunny.dy -= 1.5
  end

  if hit(g_bunny.x + g_bunny.dx, g_bunny.y, 7, 7) then
    g_bunny.dx = 0
  end

  if hit(g_bunny.x, g_bunny.y + g_bunny.dy, 7, 7) then
    if g_bunny.dy > 0 then
      g_bunny.on_ground = true
    end
    g_bunny.dy = 0
  end

  if g_bunny.on_ground then
    g_bunny.dx *= 0.95
    g_bunny.jump = 0
  end

  g_bunny.y += g_bunny.dy
  g_bunny.x += g_bunny.dx
end

function _draw()
  cls(12)
  map(0, 0, 0, 0, 16, 16)
  spr(1, g_bunny.x, g_bunny.y, 1, 1, g_bunny.facing_left)
end

function hit(x, y, w, h)
  local collide = false
  for i = x, x + w, w do
    if (fget(mget(i / 8,  y / 8)) > 0) or
       (fget(mget(i / 8, (y + h) / 8)) > 0) then
      collide = true
    end
  end
  for i = y, y + h, h do
    if (fget(mget( x / 8,      i / 8)) > 0) or
       (fget(mget((x + w) / 8, i / 8)) > 0) then
      collide = true
    end
  end
  return collide
end

__gfx__
000000000dd00dd03333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000de00de033bb3bb300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000de00de03333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000dd00dd0b33333bb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000dddddd0333bb33300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000d7ddd703333b3bb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000dddddd03333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000dddd003bb3333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020200000000000000000002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000202020200000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000002020200000202020000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000202020200000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0200000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020200000202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020200000202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
